/**
 * Dependency Vulnerability Assessment Types
 *
 * Types for npm/yarn/pnpm dependency vulnerability detection via package manager audits.
 * Implements Issue #193: Add npm/yarn dependency vulnerability detection module.
 *
 * @module assessment/dependencyVulnerabilityTypes
 */

import type { AssessmentStatus } from "./coreTypes";

// ============================================================================
// Core Types
// ============================================================================

/**
 * Severity level for dependency vulnerabilities.
 * Matches npm audit severity levels.
 */
export type VulnerabilitySeverity = "critical" | "high" | "moderate" | "low";

/**
 * Package manager detected and used for audit.
 */
export type PackageManager = "npm" | "yarn" | "pnpm" | "unknown";

/**
 * Lock file type mapping to package manager.
 */
export type LockFileType =
  | "package-lock.json"
  | "yarn.lock"
  | "pnpm-lock.yaml"
  | "none";

// ============================================================================
// Vulnerability Finding Types
// ============================================================================

/**
 * Individual vulnerability finding from audit.
 */
export interface DependencyVulnerability {
  /** Package name with vulnerability */
  packageName: string;
  /** Current installed version */
  version: string;
  /** Severity level */
  severity: VulnerabilitySeverity;
  /** Advisory title/description */
  advisory: string;
  /** CVE identifier if available */
  cve?: string;
  /** Fixed version if available */
  fixedIn?: string;
  /** Dependency path (direct or transitive) */
  dependencyPath: string[];
  /** Whether a fix is available */
  fixAvailable: boolean;
  /** Whether this is a direct or transitive dependency */
  isDirect: boolean;
}

/**
 * Summary counts by severity level.
 */
export interface VulnerabilityCounts {
  critical: number;
  high: number;
  moderate: number;
  low: number;
}

// ============================================================================
// Audit Execution Types
// ============================================================================

/**
 * Audit execution metadata.
 */
export interface AuditExecutionInfo {
  /** Package manager used */
  packageManager: PackageManager;
  /** Lock file detected */
  lockFilePresent: boolean;
  /** Lock file type (package-lock.json, yarn.lock, pnpm-lock.yaml) */
  lockFileType: LockFileType;
  /** Audit command executed */
  auditCommand: string;
  /** Execution time in ms */
  executionTimeMs: number;
  /** Whether audit completed successfully */
  auditCompleted: boolean;
  /** Error message if audit failed */
  auditError?: string;
}

// ============================================================================
// Main Assessment Result
// ============================================================================

/**
 * Main assessment result interface.
 * Field name matches Issue #193 spec: dependencyVulnerability
 */
export interface DependencyVulnerabilityAssessment {
  /** Whether a package manager was detected */
  hasPackageManager: boolean;
  /** Audit execution information */
  auditInfo: AuditExecutionInfo;
  /** Summary counts by severity */
  vulnerabilities: VulnerabilityCounts;
  /** Total number of advisories found */
  totalAdvisories: number;
  /** Individual vulnerability details */
  findings: DependencyVulnerability[];
  /** Computed score penalty (based on severity scoring) */
  scorePenalty: number;
  /** Assessment status */
  status: AssessmentStatus;
  /** Human-readable explanation */
  explanation: string;
  /** Actionable recommendations */
  recommendations: string[];
  /** Whether assessment was skipped */
  skipped?: boolean;
  /** Reason for skipping if applicable */
  skipReason?: string;
  /** Stage B enrichment data for Claude validation (future) */
  enrichmentData?: DependencyVulnerabilityEnrichmentData;
}

// ============================================================================
// Stage B Enrichment Types (Optional Future Extension)
// ============================================================================

/**
 * Enrichment data for Stage B Claude validation.
 * Can be used for more sophisticated analysis in future releases.
 */
export interface DependencyVulnerabilityEnrichmentData {
  /** Top critical/high vulnerabilities for review */
  topVulnerabilities: DependencyVulnerability[];
  /** Summary metrics */
  metrics: {
    /** Total packages scanned */
    totalPackages: number;
    /** Number of packages with vulnerabilities */
    vulnerablePackages: number;
    /** Vulnerabilities in direct dependencies */
    directDependencyVulns: number;
    /** Vulnerabilities in transitive dependencies */
    transitiveDependencyVulns: number;
  };
}

// ============================================================================
// npm Audit Output Types (Internal)
// ============================================================================

/**
 * npm vulnerability entry structure
 */
export interface NpmVulnerabilityEntry {
  name: string;
  severity: string;
  via: Array<string | { title?: string; url?: string; source?: number }>;
  effects?: string[];
  range?: string;
  nodes?: string[];
  fixAvailable?:
    | boolean
    | {
        name: string;
        version: string;
        isSemVerMajor: boolean;
      };
}

/**
 * npm audit --json output structure (npm v7+).
 * Used internally for parsing.
 */
export interface NpmAuditOutput {
  vulnerabilities?: Record<string, NpmVulnerabilityEntry>;
  metadata?: {
    vulnerabilities?: VulnerabilityCounts;
    dependencies?: {
      prod: number;
      dev: number;
      optional: number;
      peer: number;
      peerOptional: number;
      total: number;
    };
  };
}

/**
 * yarn audit --json output structure.
 * Yarn emits newline-delimited JSON objects.
 */
export interface YarnAuditEntry {
  type: "auditAdvisory" | "auditSummary";
  data:
    | {
        resolution: {
          id: number;
          path: string;
          dev: boolean;
          optional: boolean;
          bundled: boolean;
        };
        advisory: {
          module_name: string;
          severity: string;
          title: string;
          url?: string;
          cves?: string[];
          patched_versions?: string;
          vulnerable_versions?: string;
        };
      }
    | {
        vulnerabilities: {
          info: number;
          low: number;
          moderate: number;
          high: number;
          critical: number;
        };
        dependencies: number;
        devDependencies: number;
        optionalDependencies: number;
        totalDependencies: number;
      };
}

/**
 * pnpm advisory entry structure
 */
export interface PnpmAdvisoryEntry {
  module_name: string;
  severity: string;
  title: string;
  url?: string;
  cves?: string[];
  vulnerable_versions?: string;
  patched_versions?: string;
  findings?: Array<{
    version: string;
    paths: string[];
  }>;
}

/**
 * pnpm audit --json output structure.
 * Similar to npm but with some differences.
 */
export interface PnpmAuditOutput {
  advisories?: Record<string, PnpmAdvisoryEntry>;
  metadata?: {
    vulnerabilities?: VulnerabilityCounts;
    dependencies?: number;
    devDependencies?: number;
    totalDependencies?: number;
  };
}
