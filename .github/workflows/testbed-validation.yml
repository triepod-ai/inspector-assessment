name: Testbed Validation

on:
  workflow_dispatch: # Manual trigger
  schedule:
    - cron: "0 6 * * 1" # Weekly on Monday at 6 AM UTC
  push:
    paths:
      - "client/src/services/assessment/modules/SecurityAssessor.ts"
      - "client/src/lib/securityPatterns.ts"
      - "cli/src/validate-testbed.ts"
  pull_request:
    paths:
      - "client/src/services/assessment/modules/SecurityAssessor.ts"
      - "client/src/lib/securityPatterns.ts"

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      # Vulnerable MCP Testbed Server
      vulnerable-testbed:
        image: ghcr.io/triepod-ai/mcp-vulnerable-testbed:latest
        ports:
          - 10900:10900
        env:
          TRANSPORT: http
          HOST: 0.0.0.0
          VULNERABILITY_MODE: high
        options: >-
          --health-cmd "curl -sf http://localhost:10900/mcp || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # Hardened MCP Testbed Server
      hardened-testbed:
        image: ghcr.io/triepod-ai/mcp-hardened-testbed:latest
        ports:
          - 10901:10901
        env:
          TRANSPORT: http
          HOST: 0.0.0.0
        options: >-
          --health-cmd "curl -sf http://localhost:10901/mcp || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm

      - name: Install dependencies
        run: npm install --no-package-lock --ignore-scripts

      - name: Build project
        run: npm run build

      - name: Wait for testbed servers to be ready
        run: |
          echo "Waiting for vulnerable testbed (port 10900)..."
          timeout 60 bash -c 'until curl -sf http://localhost:10900/mcp > /dev/null 2>&1; do sleep 2; done'
          echo "Vulnerable testbed is ready"

          echo "Waiting for hardened testbed (port 10901)..."
          timeout 60 bash -c 'until curl -sf http://localhost:10901/mcp > /dev/null 2>&1; do sleep 2; done'
          echo "Hardened testbed is ready"

      - name: Run testbed validation
        run: npm run validate:testbed -- --verbose
        env:
          CI: true

      - name: Upload validation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: testbed-validation-results
          path: /tmp/testbed-validation-results.json
          retention-days: 30

      - name: Check validation status
        run: |
          RESULTS=$(cat /tmp/testbed-validation-results.json)
          RECALL=$(echo $RESULTS | jq -r '.vulnerable.metrics.recall // 0')
          FP_COUNT=$(echo $RESULTS | jq -r '.vulnerable.metrics.falsePositives | length // 0')
          HARDENED_VULNS=$(echo $RESULTS | jq -r '.hardened.vulnerabilities // 0')

          echo "Recall: $RECALL"
          echo "False Positives: $FP_COUNT"
          echo "Hardened Vulnerabilities: $HARDENED_VULNS"

          # Check targets: 80%+ recall, 0 false positives, 0 hardened vulns
          if (( $(echo "$RECALL < 0.8" | bc -l) )); then
            echo "::error::Recall is below 80% target"
            exit 1
          fi

          if [ "$FP_COUNT" -gt 0 ]; then
            echo "::error::Has $FP_COUNT false positives (target: 0)"
            exit 1
          fi

          if [ "$HARDENED_VULNS" -gt 0 ]; then
            echo "::error::Hardened server has $HARDENED_VULNS false positives"
            exit 1
          fi

          echo "All validation targets passed!"

  # Notify on validation failures
  notify-on-failure:
    needs: validate
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Create issue on validation failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Testbed Validation Failed';
            const body = `
            ## Testbed Validation Failed

            The SecurityAssessor validation against the MCP Vulnerable Testbed failed.

            **Workflow Run:** [View Details](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})

            **Possible Issues:**
            - Recall dropped below 80% (some vulnerabilities not detected)
            - False positives detected on safe tools
            - Hardened server incorrectly flagged

            **Action Required:**
            1. Review the validation results artifact
            2. Check recent changes to SecurityAssessor or securityPatterns
            3. Update detection patterns if needed

            cc @bryan-thompson
            `;

            // Check if similar issue exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'testbed-validation'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['testbed-validation', 'bug', 'security']
              });
            }
