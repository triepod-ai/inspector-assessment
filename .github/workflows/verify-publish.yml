name: Verify Published Package

# Manual trigger - run after publishing to npm
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to verify (e.g., 1.22.7)"
        required: false
        type: string

jobs:
  verify-npx:
    name: Verify npx Installation
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Wait for npm propagation
        run: |
          echo "Waiting 60 seconds for npm registry propagation..."
          sleep 60

      - name: Test npx installation (version check)
        run: |
          echo "Testing: npx @bryan-thompson/inspector-assessment --version"
          npx @bryan-thompson/inspector-assessment --version

      - name: Test npx installation (help)
        run: |
          echo "Testing: npx @bryan-thompson/inspector-assessment --help"
          npx @bryan-thompson/inspector-assessment --help

      - name: Test mcp-assess-full binary
        run: |
          echo "Testing: npx -p @bryan-thompson/inspector-assessment mcp-assess-full --help"
          npx -p @bryan-thompson/inspector-assessment mcp-assess-full --help

  verify-global-install:
    name: Verify Global Installation
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Wait for npm propagation
        run: |
          echo "Waiting 60 seconds for npm registry propagation..."
          sleep 60

      - name: Install globally
        run: |
          echo "Installing: npm install -g @bryan-thompson/inspector-assessment"
          npm install -g @bryan-thompson/inspector-assessment

      - name: Test global binary (version)
        run: |
          echo "Testing: mcp-inspector-assess --version"
          mcp-inspector-assess --version

      - name: Test global binary (help)
        run: |
          echo "Testing: mcp-inspector-assess --help"
          mcp-inspector-assess --help

      - name: Uninstall
        run: npm uninstall -g @bryan-thompson/inspector-assessment

  verify-bunx:
    name: Verify bunx Installation
    runs-on: ubuntu-latest
    steps:
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Wait for npm propagation
        run: |
          echo "Waiting 60 seconds for npm registry propagation..."
          sleep 60

      - name: Test bunx installation
        run: |
          echo "Testing: bunx @bryan-thompson/inspector-assessment --help"
          bunx @bryan-thompson/inspector-assessment --help

  verify-specific-version:
    name: Verify Specific Version
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.version != '' }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Wait for npm propagation
        run: sleep 60

      - name: Test specific version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "Testing version: $VERSION"
          npx @bryan-thompson/inspector-assessment@$VERSION --version
