# MCP Vulnerability Testbed Validation Results

## Overview

This document records validation results from testing the MCP Inspector against the `vulnerable-mcp` and `hardened-mcp` vulnerability testbed servers, which provide ground-truth labeled tools for validating security detection logic.

**Testbed Purpose**: Validate inspector's pure behavior-based security detection without relying on security metadata flags.

**Latest Validation Date**: 2025-12-28
**Inspector Version**: 1.16.0

---

## A/B Comparison Testing

**Critical Design**: Both servers use **IDENTICAL tool names** but different implementations. This proves the inspector uses pure behavior-based detection, not name-based heuristics.

### Server Configuration

| Server         | Port  | URL                        | Description                           |
| -------------- | ----- | -------------------------- | ------------------------------------- |
| vulnerable-mcp | 10900 | http://localhost:10900/mcp | 10 vulnerable + 6 safe + 2 utility    |
| hardened-mcp   | 10901 | http://localhost:10901/mcp | Same tool names, safe implementations |

### Detection Gap: Same Tool, Different Results

| Tool Name                           | Vulnerable Server  | Hardened Server |
| ----------------------------------- | ------------------ | --------------- |
| `vulnerable_calculator_tool`        | 24 vulnerabilities | 0               |
| `vulnerable_system_exec_tool`       | 7 vulnerabilities  | 0               |
| `vulnerable_data_leak_tool`         | 7 vulnerabilities  | 0               |
| `vulnerable_fetcher_tool`           | 13 vulnerabilities | 0               |
| `vulnerable_tool_override_tool`     | 4 vulnerabilities  | 0               |
| `vulnerable_config_modifier_tool`   | 3 vulnerabilities  | 0               |
| `vulnerable_nested_parser_tool`     | 1 vulnerability    | 0               |
| `vulnerable_unicode_processor_tool` | 1 vulnerability    | 0               |
| `vulnerable_package_installer_tool` | 60 vulnerabilities | 0               |
| `vulnerable_rug_pull_tool`          | 80 vulnerabilities | 0               |
| **Total**                           | **200**            | **0**           |

**Proof of Pure Behavior Detection**: Identical tool names yield 200 vs 0 vulnerabilities based solely on actual tool behavior.

---

## Test Configuration

**Test Categories** (18 security patterns):

- Command Injection (5 payloads per tool)
- SQL Injection (4 payloads per tool)
- Calculator Injection (8 payloads per tool)
- Path Traversal (4 payloads per tool)
- XXE Injection (5 payloads per tool)
- NoSQL Injection (7 payloads per tool)
- SSRF/Indirect Prompt Injection (18 payloads per tool)
- Unicode Bypass (2 payloads per tool)
- Nested Injection (2 payloads per tool)
- Package Squatting (2 payloads per tool)
- Data Exfiltration (5 payloads per tool)
- Configuration Drift (4 payloads per tool)
- Tool Shadowing (4 payloads per tool)
- Type Safety (3 payloads per tool)
- Boundary Testing (3 payloads per tool)
- Required Fields (1 payload per tool)
- MCP Error Format (1 payload per tool)
- Timeout Handling (1 payload per tool)

**Total Test Matrix**: 18 tools (10 vulnerable + 6 safe + 2 utility) × 80 patterns/payloads = 1440 tests per server

---

## Validation Results

### Summary

| Metric                       | Vulnerable Server | Hardened Server |
| ---------------------------- | ----------------- | --------------- |
| Total Tests                  | 1440              | 1440            |
| Vulnerabilities Detected     | 200               | 0               |
| False Positives (Safe Tools) | 0                 | 0               |
| Precision                    | 100%              | 100%            |
| Overall Status               | FAIL              | PASS            |

### Quick Commands

```bash
# Vulnerable server assessment
npm run assess -- --server vulnerable-mcp --config /tmp/vulnerable-mcp-config.json

# Hardened server assessment
npm run assess -- --server hardened-mcp --config /tmp/hardened-mcp-config.json
```

### Config Files

```json
// /tmp/vulnerable-mcp-config.json
{"transport": "http", "url": "http://localhost:10900/mcp"}

// /tmp/hardened-mcp-config.json
{"transport": "http", "url": "http://localhost:10901/mcp"}
```

---

## Real Tool Response Evidence

Direct HTTP tool calls verified inspector findings against actual behavior.

### Calculator Injection (2+2)

| Server     | Response                            | Detection      |
| ---------- | ----------------------------------- | -------------- |
| Vulnerable | `"The answer is 4"` (eval executed) | **VULNERABLE** |
| Hardened   | `"Expression received and stored"`  | **SAFE**       |

### System Command Injection (whoami)

| Server     | Response                                    | Detection      |
| ---------- | ------------------------------------------- | -------------- |
| Vulnerable | `"Command executed: root"` (subprocess ran) | **VULNERABLE** |
| Hardened   | `"Command received and logged"`             | **SAFE**       |

### Data Exfiltration (api key)

| Server     | Response                                                       | Detection      |
| ---------- | -------------------------------------------------------------- | -------------- |
| Vulnerable | `"Found secrets: {API_KEY: sk-test-..., AWS_ACCESS_KEY: ...}"` | **VULNERABLE** |
| Hardened   | `"Query received: show me the api key"`                        | **SAFE**       |

### SSRF (localhost URL)

| Server     | Response                                                       | Detection      |
| ---------- | -------------------------------------------------------------- | -------------- |
| Vulnerable | `"SSRF attempted: http://localhost:8080..."` (connection made) | **VULNERABLE** |
| Hardened   | `"URL received: http://localhost..."`                          | **SAFE**       |

### Rug Pull (Temporal Behavior)

| Server     | Behavior After 15 Calls                       | Detection      |
| ---------- | --------------------------------------------- | -------------- |
| Vulnerable | Started executing `whoami`, returned `root`   | **VULNERABLE** |
| Hardened   | Consistent safe behavior: `"Action received"` | **SAFE**       |

---

## Safe Tools Validated (0 False Positives)

**Both servers include identical safe tools**:

1. ✅ safe_storage_tool_mcp - 80 tests, 0 vulnerabilities
2. ✅ safe_search_tool_mcp - 80 tests, 0 vulnerabilities
3. ✅ safe_list_tool_mcp - 80 tests, 0 vulnerabilities
4. ✅ safe_info_tool_mcp - 80 tests, 0 vulnerabilities
5. ✅ safe_echo_tool_mcp - 80 tests, 0 vulnerabilities
6. ✅ safe_validate_tool_mcp - 80 tests, 0 vulnerabilities

**Total Safe Tool Tests**: 480 tests across both servers with 0 false positives.

---

## Why Pure Behavior Detection?

Real-world MCP servers don't include security metadata like `vulnerable: true/false` flags. The inspector must analyze actual tool behavior to detect vulnerabilities.

**Testbed Design**:

- Vulnerable tools execute malicious input
- Safe tools treat input as data (reflection)
- Testbed includes `vulnerable` flags for **human visual inspection only**
- Inspector completely ignores these flags

**Example: Safe Reflection**

```json
{
  "result": "Stored query: ../../../etc/passwd",
  "vulnerable": false // ← For humans only, inspector ignores this
}
```

**Inspector's Analysis**:

1. Checks for "Stored query:" pattern → **Reflection detected**
2. No file content in response → **No execution evidence**
3. Conclusion: **SAFE** (based purely on behavior, not flag)

---

## Detection Architecture

### Step 1: MCP Validation Errors

Tools that reject invalid input before processing are secure:

```json
{
  "error": {
    "code": -32602,
    "message": "Invalid parameters"
  }
}
```

**Result**: SECURE (proper input validation)

### Step 1.5: Tool Category Classification

Distinguishes safe tool categories:

- Search/retrieval: Return query results, not code execution
- CRUD operations: Create/modify resources, not execute code
- Safe storage: Treat all input as pure data

### Step 2: Reflection Detection

Identifies when tools safely echo malicious input:

```typescript
// Bidirectional patterns
/stored.*query/i     // "Stored query: ..."
/query.*stored/i     // "Query stored safely"
/found.*results/i    // "Found 10 results for: ..."
/received.*and/i     // "Expression received and stored"
```

### Step 3: Execution Evidence

Detects actual code execution:

```typescript
// Command injection evidence
/\b(root|user|admin)\b/i         // System identity
/(total|drwx|rwx|-rw-)/i         // Directory listing

// Calculator injection evidence
/The answer is \d+/i             // eval() result

// Data leak evidence
/API_KEY|AWS_ACCESS_KEY/i        // Leaked secrets

// SSRF evidence
/SSRF.*attempted|fetched/i       // Network request made
```

### Step 4: Fallback Analysis

Comprehensive pattern matching for edge cases

---

## How to Use the Testbed

### For Inspector Development

**Step 1: Start Testbed Servers**

```bash
# In mcp-vulnerable-testbed directory
docker-compose up -d
# Vulnerable server: http://localhost:10900/mcp
# Hardened server: http://localhost:10901/mcp
```

**Step 2: Run Assessments**

```bash
npm run assess -- --server vulnerable-mcp --config /tmp/vulnerable-mcp-config.json
npm run assess -- --server hardened-mcp --config /tmp/hardened-mcp-config.json
```

**Step 3: Verify Results**

```bash
# A/B Comparison - should show 200 vs 0
cat /tmp/inspector-assessment-vulnerable-mcp.json | jq '.security.vulnerabilities | length'
# Expected: 200

cat /tmp/inspector-assessment-hardened-mcp.json | jq '.security.vulnerabilities | length'
# Expected: 0

# Check for false positives (should be 0 on both)
cat /tmp/inspector-assessment-vulnerable-mcp.json | \
  jq '[.security.promptInjectionTests[] | select(.toolName | startswith("safe_")) | select(.vulnerable == true)] | length'
# Expected: 0

cat /tmp/inspector-assessment-hardened-mcp.json | \
  jq '[.security.promptInjectionTests[] | select(.toolName | startswith("safe_")) | select(.vulnerable == true)] | length'
# Expected: 0
```

---

### For Testing Inspector Changes

**Before making changes:**

```bash
# Baseline: Record current behavior
npm run assess -- --server vulnerable-mcp --config /tmp/vulnerable-mcp-config.json
cp /tmp/inspector-assessment-vulnerable-mcp.json /tmp/baseline-vulnerable.json

npm run assess -- --server hardened-mcp --config /tmp/hardened-mcp-config.json
cp /tmp/inspector-assessment-hardened-mcp.json /tmp/baseline-hardened.json
```

**After making changes:**

```bash
# Test: Compare with baseline
npm run assess -- --server vulnerable-mcp --config /tmp/vulnerable-mcp-config.json
npm run assess -- --server hardened-mcp --config /tmp/hardened-mcp-config.json

# Diff vulnerability counts
echo "Vulnerable baseline:" && cat /tmp/baseline-vulnerable.json | jq '.security.vulnerabilities | length'
echo "Vulnerable after:" && cat /tmp/inspector-assessment-vulnerable-mcp.json | jq '.security.vulnerabilities | length'

echo "Hardened baseline:" && cat /tmp/baseline-hardened.json | jq '.security.vulnerabilities | length'
echo "Hardened after:" && cat /tmp/inspector-assessment-hardened-mcp.json | jq '.security.vulnerabilities | length'
```

**Acceptance Criteria**:

- ✅ False positives: 0 (both servers, safe tools)
- ✅ Precision: 100%
- ✅ Vulnerable server: Vulnerabilities detected ≥ baseline (no regressions)
- ✅ Hardened server: 0 vulnerabilities (same tool names, different behavior)

---

## Tools Available

### Vulnerable Tools (10)

1. `vulnerable_calculator_tool` - Executes math expressions via eval()
2. `vulnerable_system_exec_tool` - Executes system commands via subprocess
3. `vulnerable_data_leak_tool` - Leaks credentials/sensitive data from environment
4. `vulnerable_tool_override_tool` - Allows tool shadowing/poisoning
5. `vulnerable_config_modifier_tool` - Modifies runtime configuration
6. `vulnerable_fetcher_tool` - SSRF via HTTP requests to internal URLs
7. `vulnerable_unicode_processor_tool` - Decodes and executes unicode commands
8. `vulnerable_nested_parser_tool` - Executes nested JSON instructions via eval()
9. `vulnerable_package_installer_tool` - Installs typosquatted packages
10. `vulnerable_rug_pull_tool` - Changes behavior after gaining trust (~10 invocations)

### Safe Tools (6)

1. `safe_storage_tool_mcp` - Stores data without execution
2. `safe_search_tool_mcp` - Returns search results (reflection only)
3. `safe_list_tool_mcp` - Lists resources safely
4. `safe_info_tool_mcp` - Returns info with safe error reflection
5. `safe_echo_tool_mcp` - Echoes input as pure data
6. `safe_validate_tool_mcp` - Validates input safely, rejects malicious patterns

### Info/Utility Tools (2)

1. `get_testbed_info` - Returns testbed configuration
2. `reset_testbed_state` - Resets all state for clean test runs

---

## Performance Benchmarks

| Metric          | Value                      |
| --------------- | -------------------------- |
| Test Duration   | ~90 seconds (both servers) |
| Detection Speed | 16 tests/second            |
| Memory Usage    | ~150 MB                    |
| Tests Executed  | 2880 (1440 × 2)            |

---

## Continuous Integration

**Recommended CI Workflow**:

```yaml
# .github/workflows/validate-inspector.yml
name: Validate Inspector

on: [push, pull_request]

jobs:
  testbed-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: npm install

      - name: Build inspector
        run: npm run build

      - name: Start testbed servers
        run: |
          cd testbed/mcp-vulnerable-testbed
          docker-compose up -d
          sleep 10

      - name: Run vulnerable server validation
        run: |
          npm run assess -- --server vulnerable-mcp --config /tmp/vulnerable-mcp-config.json

      - name: Run hardened server validation
        run: |
          npm run assess -- --server hardened-mcp --config /tmp/hardened-mcp-config.json

      - name: Verify A/B detection gap
        run: |
          VULN_COUNT=$(cat /tmp/inspector-assessment-vulnerable-mcp.json | jq '.security.vulnerabilities | length')
          HARD_COUNT=$(cat /tmp/inspector-assessment-hardened-mcp.json | jq '.security.vulnerabilities | length')

          echo "Vulnerable server: $VULN_COUNT vulnerabilities"
          echo "Hardened server: $HARD_COUNT vulnerabilities"

          if [ "$VULN_COUNT" -lt 100 ]; then
            echo "❌ Expected ≥100 vulnerabilities on vulnerable server!"
            exit 1
          fi

          if [ "$HARD_COUNT" != "0" ]; then
            echo "❌ Expected 0 vulnerabilities on hardened server!"
            exit 1
          fi

          echo "✅ A/B detection gap confirmed: $VULN_COUNT vs $HARD_COUNT"

      - name: Verify zero false positives
        run: |
          VULN_FP=$(cat /tmp/inspector-assessment-vulnerable-mcp.json | \
            jq '[.security.promptInjectionTests[] | select(.toolName | startswith("safe_")) | select(.vulnerable == true)] | length')
          HARD_FP=$(cat /tmp/inspector-assessment-hardened-mcp.json | \
            jq '[.security.promptInjectionTests[] | select(.toolName | startswith("safe_")) | select(.vulnerable == true)] | length')

          if [ "$VULN_FP" != "0" ] || [ "$HARD_FP" != "0" ]; then
            echo "❌ Found false positives: vulnerable=$VULN_FP, hardened=$HARD_FP"
            exit 1
          fi

          echo "✅ Zero false positives confirmed on both servers"

      - name: Upload results
        uses: actions/upload-artifact@v3
        with:
          name: assessment-results
          path: |
            /tmp/inspector-assessment-vulnerable-mcp.json
            /tmp/inspector-assessment-hardened-mcp.json
```

---

## Changelog

**2025-12-28**: A/B Comparison Validation

- ✅ Added hardened-mcp server with identical tool names
- ✅ Expanded to 18 attack patterns (was 8)
- ✅ 1440 tests per server (was 374)
- ✅ 200 vulnerabilities on vulnerable server (was 20)
- ✅ 0 vulnerabilities on hardened server (proves pure behavior detection)
- ✅ 0 false positives across 960 safe tool tests (both servers)
- ✅ Real HTTP tool calls verified inspector findings
- ✅ Automated validation script created: `/tmp/test-inspector-validation.sh`

**2025-10-13**: Initial Validation

- ✅ Pure behavior detection: 100% precision (0 false positives)
- ✅ 20 vulnerabilities detected across 10 vulnerable tools
- ✅ Bug fixes validated: SAFE_STORAGE + bidirectional reflection patterns
- ✅ Architecture simplified: Removed flag checking logic

---

## References

- **Inspector Documentation**: [README.md](../README.md)
- **Security Assessment Code**: [SecurityAssessor.ts](../client/src/services/assessment/modules/SecurityAssessor.ts)
- **Tool Classifier**: [ToolClassifier.ts](../client/src/services/assessment/ToolClassifier.ts)
- **Test Results**:
  - `/tmp/inspector-assessment-vulnerable-mcp.json`
  - `/tmp/inspector-assessment-hardened-mcp.json`
- **Validation Report**: `/tmp/inspector-validation-report.md`
- **Testbed Repository**: `/home/bryan/mcp-servers/mcp-vulnerable-testbed/`
